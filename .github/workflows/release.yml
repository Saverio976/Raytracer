name: Build and release

on:
  push:
    tags:
      - '*'

jobs:

  release-exe:
    runs-on: ubuntu-latest
    container: epitechcontent/epitest-docker:latest

    steps:
      - name: Clone
        uses: actions/checkout@v3

      - name: Install dependencies
        run: sudo dnf install -y tar gzip libconfig-devel libconfig

      - name: Configure CMake
        run: cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build ${{github.workspace}}/build --config Release

      - name: Package to archive (binary)
        run: |
          mkdir raytracer-bin
          cp raytracer raytracer-bin/raytracer
          cp -r plugins raytracer-bin/
          tar -czf raytracer.tar.gz raytracer-bin -I 'gzip -9'

      - name: Upload to release (binary)
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: "raytracer.tar.gz"
          tag: ${{ github.ref }}
          overwrite: true

      - name: Package to archive (examples)
        run: |
          mkdir raytracer-examples
          cp scenes/**/*.yaax scenes/*.yaax raytracer-examples/
          find raytracer-examples -name '*.yaax' -type f -print -exec ./raytracer --scene-path {} --output-path {} \;
          tar -czf raytracer-examples.tar.gz raytracer-examples -I 'gzip -9'

      - name: Upload to release (examples)
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: "raytracer-examples.tar.gz"
          tag: ${{ github.ref }}
          overwrite: true
